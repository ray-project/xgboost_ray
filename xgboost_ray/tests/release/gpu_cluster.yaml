cluster_name: xgboost_ray_release_tests_gpu
min_workers: 3
max_workers: 3
initial_workers: 3
autoscaling_mode: default
docker:
    image: "rayproject/ray:latest-gpu"
    container_name: ray_container
    pull_before_run: false
    run_options:
        - --privileged
target_utilization_fraction: 0.8
idle_timeout_minutes: 5
provider:
    type: aws
    region: us-west-2
    availability_zone: us-west-2a
    cache_stopped_nodes: true
auth:
    ssh_user: ubuntu
head_node:
    InstanceType: m5.xlarge
    ImageId: ami-0a2363a9cff180a64 # Deep Learning AMI (Ubuntu) Version 30
    BlockDeviceMappings:
      - DeviceName: /dev/sdf
        Ebs:
          DeleteOnTermination: true
          VolumeSize: 65
          # /data/parted.parquet. 1.5B rows, 4 features, 2 labels
          SnapshotId: snap-0ffe33e7d1b9fd395
worker_nodes:
    InstanceType: p2.xlarge
    ImageId: ami-0a2363a9cff180a64 # Deep Learning AMI (Ubuntu) Version 30
    #InstanceMarketOptions:
    #    MarketType: spot
    BlockDeviceMappings:
      - DeviceName: /dev/sdf
        Ebs:
          DeleteOnTermination: true
          VolumeSize: 65
          SnapshotId: snap-0ffe33e7d1b9fd395

file_mounts: {
  "/release_tests": "./"
}
cluster_synced_files: []
file_mounts_sync_continuously: true
initialization_commands: []
setup_commands:
  - mkdir -p /data
  - pip install -U ray
  - pip install -U git+https://github.com/ray-project/xgboost_ray#xgboost-ray
  - pip install -U pyarrow
head_setup_commands:
  - if ! `ls /data/lost+found`; then mount /dev/nvme0n1 /data; fi
worker_setup_commands:
  - if ! `ls /data/lost+found`; then mount /dev/nvme1n1 /data; fi
head_start_ray_commands:
    - ray stop
    - "ulimit -n 65536; ray start --head --port=6379 --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml --resources='{\"actor_cpus\": 0, \"actor_gpus\": 0}'"
worker_start_ray_commands:
    - ray stop
    - "ulimit -n 65536; ray start --address=$RAY_HEAD_IP:6379 --object-manager-port=8076 --resources='{\"actor_cpus\": 4, \"actor_gpus\": 1}'"
metadata:
    anyscale:
        working_dir: "/release_tests"
